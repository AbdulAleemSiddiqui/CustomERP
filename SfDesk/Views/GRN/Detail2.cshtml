@model  IEnumerable<SfDesk.Models.GRN>


@{
    Layout = null;
}

<link href="~/assets/css/jsgrid.min.css" rel="stylesheet" />

<link href="~/assets/css/jsgrid-theme.min.css" rel="stylesheet" />
<style>
    .total-row td {
        border-top: 2px solid #efefef;
    }
</style>
<div id="main-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="card alert">

                <div class="jsgrid-table-panel">
                    <div id="Grid" class="table table-striped table-bordered dataTable no-footer" style="float:right"></div>

                </div>
                </div>
            </div>
        </div>
    </div>
<script>
    taxes =[]
    $(document).ready(function () {

        $.ajax({
            type: "GET",
            url: "Get_taxes",
            dataType: "json",
            success: function (d) {

                if (d.ID != 0)
                    taxes = d
                tax();
            }
        });
        


       

    });
 function tax() {
     $("#Grid").jsGrid({

         height: "auto",
         width: "30%",
         filtering: false,
         editing: false,
         inserting: true,
         sorting: true,
         paging: true,
         autoload: true,
         pageSize: 15,
         pageButtonCount: 5,
         deleteConfirm: "confirm",
         data: taxes,
         controller: {
             insertItem: function (insertingClient) {

                 // this.clients.push(insertingClient);
                 $.ajax({
                     type: "POST",
                     data: { PI_ID: $('#PI_ID').val(), s: insertingClient },
                     url: "Save_Charges",
                     success: function (d) {
                         alert(d);


                     },
                 })
             },



             deleteItem: function (deletingClient) {
                 $.ajax({
                     type: "GET",
                     data: deletingClient,
                     url: "Delete",
                     success: function (d) {
                         alert(d);
                     },
                 })
             }
         },
         pagerContainer: null,
         pageIndex: 1,
         pageSize: 20,
         pageButtonCount: 15,
         pagerFormat: "Pages: {first} {prev} {pages} {next} {last}    {pageIndex} of {pageCount}",
         pagePrevText: "Prev",
         pageNextText: "Next",
         pageFirstText: "First",
         pageLastText: "Last",
         pageNavigatorNextText: "...",
         pageNavigatorPrevText: "...",

         invalidMessage: "Invalid data entered!",

         onItemInserting: function (args) {


             args.item["PI_ID"] = Master_Id;



             $("#grid").jsGrid("insertItem", args.item);
         },
         //onRefreshed: function (args) {
         //    var items = args.grid.option("data");
         //    var total = { Name: "Total", "Rate": 0, "Total": 0, IsTotal: true };
         //    debugger;
         //    items.forEach(function (item) {

         //    });
         //    var tax_total = total.Total;
         //    total.Total = net_total + tax_total
         //    total.Total = parseFloat(total.Total.toFixed(2));
         //    var $totalRow = $("<tr>").addClass("total-row");

         //    args.grid._renderCells($totalRow, total);
         //    debugger;

         //    args.grid._content.append($totalRow);
         //},

         fields: [

         {
             name: "SalesTax_ID", title: "Tax", type: "select", width: 80, validate: "required",
             items: taxes, valueField: "SalesTax_ID", textField: "SalesTax_Name",
             insertTemplate: function () {
                 var teamField = this._grid.fields[1];
                 var Total = this._grid.fields[2];
                 var $insertControl = jsGrid.fields.select.prototype.insertTemplate.call(this);

                 $insertControl.on("change", function () {
                     var selectedDepartment1 = $(this).find('option:selected').val();
                     debugger
                     $.each(taxes, function (i, val) {
                         console.log(val["SalesTax_ID"])
                         if (val["SalesTax_ID"] == selectedDepartment1) {
                             var $u = jsGrid.fields.text.prototype.insertTemplate.call(teamField);

                             $u.val(val["Rate"])//val(unit);
                             $u.text(val["Rate"])//val(unit);

                             var a = $(".abc").empty();

                             $(".abc").append($u);
                             var $t = jsGrid.fields.text.prototype.insertTemplate.call(Total);
                             debugger;
                             var val = $u.val()
                             var total = net_total * (val / 100);
                             total = total.toFixed(2);
                             $t.val(total)//val(unit);
                             $t.text(total)//val(unit);

                             var a = $(".ttl").empty();

                             $(".ttl").append($t);
                             var sum = 0;

                         }
                     });
                 });

                 return $insertControl;
             },
         },
         { name: "Rate", title: "Rate", insertcss: "abc", type: "text", width: 80, validate: "required" },
         { name: "Total", title: "total", type: "text", width: 80, validate: "required", insertcss: "ttl" },


         {
             type: "control", editButton: false,
             itemTemplate: function (_, item) {

                 if (item.IsTotal)
                     return "";
                 return jsGrid.fields.control.prototype.itemTemplate.apply(this, arguments);
             }
         }

         ]

     });

 }   </script>
